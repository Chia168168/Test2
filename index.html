<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teng Image Tools v2.1</title>
<style>
body{font-family:Arial;margin:20px;background:#0b1020;color:#e7ecf3}
h1,h2{text-align:center}
.tabs{display:flex;justify-content:center;margin-bottom:20px;gap:10px;flex-wrap:wrap}
.tab{padding:10px 20px;cursor:pointer;border-radius:6px;background:#002366;color:#fff;font-weight:bold}
.tab.active{background:#0044aa}
.tab-content{display:none}
.tab-content.active{display:block}
.card{background:#141a2e;border:1px solid #27314a;border-radius:12px;padding:16px;margin:12px auto;max-width:100%}
.file-btn{display:inline-block;padding:10px 20px;background:#002366;color:#fff;border-radius:6px;cursor:pointer;margin:5px 0;text-align:center}
.file-btn input[type=file]{display:none}
.thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.thumb{background:#0c1226;border:1px solid #27314a;border-radius:12px;overflow:hidden;text-align:center;padding:5px}
.thumb img{width:100%;display:block;max-width:120px;height:auto;margin:0 auto}
.thumb .meta{padding-top:4px;font-size:12px;color:#9aa4b2;word-break:break-all}
.drop{border:2px dashed #2b3b66;border-radius:10px;padding:18px;text-align:center;color:#c7d2fe;background:#0d1330;margin-bottom:10px}
.log{font-family:monospace;background:#0a0f22;border:1px solid #27314a;border-radius:8px;padding:10px;height:160px;overflow:auto}
label{display:block;margin-top:10px;font-size:14px;color:#9aa4b2}
.range-inline{display:flex;align-items:center;gap:8px}
.range-inline input[type=range]{flex:1}
.small-badge{font-size:13px;color:#c7d2fe;background:#0d1330;padding:4px 8px;border-radius:6px;border:1px solid #27314a}
button{padding:8px 16px;margin-right:10px;border-radius:6px;background:#002366;color:#fff;border:none;cursor:pointer;font-weight:bold}
button:hover{background:#0044aa}
@media(max-width:600px){body{margin:5px}.card{margin:5px;padding:12px}button,select,input,textarea{width:100%!important;box-sizing:border-box;font-size:16px}}
</style>
<script src="https://cdn.jsdelivr.net/npm/pica@8.0.0/dist/pica.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
</head>
<body>
<h1>Teng Image Tools v2.1</h1>

<div class="tabs">
  <div class="tab active" data-tab="resizer">尺寸格式調整</div>
  <div class="tab" data-tab="base64">Base64轉換</div>
</div>

<!-- 尺寸格式調整區 -->
<div id="resizer" class="tab-content active">
  <section class="card">
    <h2>圖片尺寸/格式調整器</h2>
    <div class="drop" id="drop">拖曳圖片或資料夾到這裡</div>
    <label class="file-btn">選擇檔案<input id="fileFiles" type="file" accept="image/*,.heic,.heif" multiple></label>
    <label class="file-btn">選擇資料夾<input id="fileFolder" type="file" webkitdirectory></label>

    <h3>執行</h3>
    <button id="process">開始處理</button>
    <button id="clear">清空</button>

    <h3>輸出選項</h3>
    <label>輸出格式
      <select id="format">
        <option value="keep">維持原格式</option>
        <option value="image/jpeg" selected>JPEG</option>
        <option value="image/png">PNG</option>
        <option value="image/webp">WebP</option>
      </select>
    </label>
    <label>長邊
      <select id="longSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input id="longSideCustom" type="number" placeholder="自訂長邊" style="display:none;margin-top:5px;">
    </label>
    <label>短邊
      <select id="shortSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input id="shortSideCustom" type="number" placeholder="自訂短邊" style="display:none;margin-top:5px;">
    </label>
    <label><input id="lock" type="checkbox" checked> 維持長寬比</label>

    <label>縮放比例 (%)</label>
    <div class="range-inline">
      <input id="scale" type="range" min="10" max="200" value="100">
      <div class="small-badge" id="scaleLabel">100%</div>
    </div>

    <div id="jpegQualityWrap" style="margin-top:10px; display:block;">
      <label>JPG 品質 (%)</label>
      <div class="range-inline">
        <input id="jpegQuality" type="range" min="1" max="100" value="90">
        <div class="small-badge" id="jpegQualityLabel">90%</div>
      </div>
    </div>

    <div id="note" style="color:#ff7777;margin-top:5px;">注意：已設定長/短邊，縮放比例將忽略</div>

    <h3>預覽</h3>
    <div id="thumbs" class="thumbs"></div>
    <h3>日誌</h3>
    <div id="log" class="log"></div>
  </section>
</div>

<!-- Base64 轉換區 -->
<div id="base64" class="tab-content">
  <section class="card">
    <h2>圖片 → Base64</h2>
    <div class="drop" id="dropBase64">拖曳圖片或資料夾到這裡</div>
    <label class="file-btn">選擇檔案<input id="base64Files" type="file" accept="image/*,.heic,.heif" multiple></label>
    <label class="file-btn">選擇資料夾<input id="base64Folder" type="file" webkitdirectory></label>
    <button id="downloadBase64Btn">下載 Base64 txt</button>
    <button id="downloadAllZip">下載全部 ZIP</button>
    <div id="thumbsBase64" class="thumbs"></div>
  </section>
</div>

<script>
const picaInstance = window.pica({features:['js','wasm','cib']});

// tab 切換
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// ===== Base64 多檔案功能 =====
const thumbsBase64 = document.getElementById('thumbsBase64');
const base64Queue = [];

async function handleBase64Files(list){
  for(const file of list){
    let f = file;
    if(f.name.toLowerCase().endsWith('.heic') || f.name.toLowerCase().endsWith('.heif')){
      const blob = await heic2any({ blob:f, toType:'image/png' });
      f = new File([blob], f.name.replace(/\.(heic|heif)$/i,'.png'), {type:'image/png'});
    }
    const reader = new FileReader();
    reader.onload = e=>{
      const dataURL = e.target.result;
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = new Image();
      img.src = dataURL;
      div.appendChild(img);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = f.name;
      div.appendChild(meta);
      thumbsBase64.appendChild(div);
      base64Queue.push({file:f, dataURL});
    };
    reader.readAsDataURL(f);
  }
  console.log(`加入 ${list.length} 個檔案`);
}

const dropBase64 = document.getElementById('dropBase64');
dropBase64.addEventListener('dragover', e=>{ e.preventDefault(); });
dropBase64.addEventListener('drop', e=>{ e.preventDefault(); handleBase64Files([...e.dataTransfer.files]); });

document.getElementById('base64Files').addEventListener('change', e=>handleBase64Files([...e.target.files]));
document.getElementById('base64Folder').addEventListener('change', e=>handleBase64Files([...e.target.files]));

document.getElementById('downloadBase64Btn').addEventListener('click', ()=>{
  if(base64Queue.length===0){alert('尚未加入檔案'); return;}
  base64Queue.forEach(item=>{
    const blob = new Blob([item.dataURL.split(',')[1]], {type:'text/plain'});
    saveAs(blob, item.file.name+'.txt');
  });
});

document.getElementById('downloadAllZip').addEventListener('click', async ()=>{
  if(base64Queue.length===0){alert('尚未加入檔案'); return;}
  const zip = new JSZip();
  base64Queue.forEach(item=>{
    zip.file(item.file.name+'.txt', item.dataURL.split(',')[1]);
  });
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content,'base64_images.zip');
});
</script>
</body>
</html>
